define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_events","core/modal_factory","block_enrolcode/modal_code","block_enrolcode/modal_enter"],function(a,b,c,d,e,f,g,h,i,j){return{generateEnrolURL:function(a){return f.relativeUrl("/blocks/enrolcode/enrol.php?code="+a)},getCode:function(d){this.injectCSS();var g=this;console.log("MAIN.getCode(src)",d);var j=a(d).closest("form"),k=+a(j).find('[name="courseid"]').val(),l=+a(j).find('[name="roleid"]').val(),m=a(j).find('[name="custommaturity"]').is(":checked")?1:0,n=new Date(a(j).find("#id_maturity_year").val(),a(j).find("#id_maturity_month").val()-1,a(j).find("#id_maturity_day").val(),a(j).find("#id_maturity_hour").val(),a(j).find("#id_maturity_minute").val(),0,0);console.log({courseid:k,roleid:l,custommaturity:m,maturity:Math.ceil(n.getTime()/1e3),readable:n}),b.call([{methodname:"block_enrolcode_get",args:{courseid:k,roleid:l,custommaturity:m,maturity:Math.ceil(n.getTime()/1e3)},done:function(b){""!=b&&null!=b?(console.log("Got code",b),h.create({type:i.TYPE}).then(function(c){var d=c.getRoot();a(d).find("#code").html(b),a(d).find("#enrolurl").val(g.generateEnrolURL(b)),a(d).find("#qrcode").attr("src",f.relativeUrl("/blocks/enrolcode/pix/qr.php?format=base64&txt="+btoa(g.generateEnrolURL(b)))),c.show()})):h.create({type:h.types.OK,title:"Error",body:e.render("block_enrolcode/code_get_error",{})}).then(function(a){a.show()})},fail:c.exception}])},getCodeModal:function(a){this.injectCSS(),b.call([{methodname:"block_enrolcode_form",args:{courseid:a},done:function(a){d.get_strings([{key:"code:get",component:"block_enrolcode"}]).done(function(b){h.create({type:h.types.OK,title:b[0],body:a}).then(function(a){var b=a.getRoot();b.on(g.OK,function(){console.log("Hiding modal"),a.hide()}),a.show()})}).fail(c.exception)},fail:c.exception}])},injectButton:function(b){"undefined"==typeof b||b<=1||d.get_strings([{key:"code:get",component:"block_enrolcode"}]).done(function(c){a("#page-content div.enrolusersbutton").parent().prepend(a('<a href="#" onclick="require([\'block_enrolcode/main\'], function(MAIN) { MAIN.getCodeModal('+b+'); }); return false;" class="btn btn-secondary">'+c[0]+"</a>"))}).fail(c.exception)},injectCSS:function(){0==a('head>link[href$="/blocks/enrolcode/style/enrolcode.css"]').length&&(console.log("Adding CSS File ",f.relativeUrl("/blocks/enrolcode/style/enrolcode.css")),a("head").append(a('<link rel="stylesheet" type="text/css" href="'+f.relativeUrl("/blocks/enrolcode/style/enrolcode.css")+'">')))},injectMainmenuButton:function(){d.get_strings([{key:"code:accesscode",component:"block_enrolcode"}]).done(function(b){a('.usermenu .dropdown a[href$="/user/preferences.php"]').after(a("<a>").attr("href","#").attr("onclick","require(['block_enrolcode/main'], function(MAIN) { MAIN.sendCodeModal(); }); return false;").addClass("dropdown-item menu-action").attr("role","menuitem").attr("data-title","moodle,accesscard").attr("aria-labelledby","actionmenuaction-accesscard").attr("data-ajax","false").append([a("<i>").addClass("icon fa fa-key fa-fw").attr("aria-hidden","true"),a("<span>").addClass("menu-action-text").attr("id","actionmenuaction-accesscard").html(b[0])]))}).fail(c.exception)},revokeCode:function(a){this.injectCSS();console.log("MAIN.revokeCode(code)",a),b.call([{methodname:"block_enrolcode_revoke",args:{code:a},done:function(a){},fail:c.exception}])},sendCode:function(d,e){this.injectCSS();console.log("MAIN.sendCode(uniqid, code)",d,e),"undefined"!=typeof d&&""!=d&&(e=a("#code-"+d).val()),b.call([{methodname:"block_enrolcode_send",args:{code:e},done:function(a){console.log("Got courseid ",a),a>1?top.location.href=f.relativeUrl("/course/view.php?id="+a,{}):h.create({type:h.types.OK,title:"Error",body:"Invalid code"}).then(function(a){a.show()})},fail:c.exception}])},sendCodeModal:function(){this.injectCSS(),h.create({type:j.TYPE}).then(function(a){a.show()})},shareCode:function(b){console.log("MAIN.shareCode(src)",b);var c=a(b).attr("data-target"),d=a(b).closest(".container").find("#code").html(),e=MAIN.generateEnrolURL(d);switch(c){case"facebook":window.open("https://www.facebook.com/sharer.php?u="+encodeURI(e))}}}});