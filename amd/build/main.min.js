define(["jquery","core/ajax","core/notification","core/str","core/templates","core/url","core/modal_events","core/modal_factory"],function(g,c,e,f,d,b,h,a){return{debug:false,applyRules:function(k,j){var i=this;if(i.debug){console.log("local_experience/main:applyRule(level, allrules)",k,j)}g("body").removeClass("local-experience-level-0").removeClass("local-experience-level-1").addClass("local-experience-level-"+k);j.forEach(function(l){if(i.debug){console.log("=> apply Rule",l)}elementstoset=l.elementstoset.split("\n");elementstoset.forEach(function(m){try{var o=m.split("=");if(o.length==2){if(typeof k!=="undefined"&&k==0){g(o[0]).val(o[1])}}}catch(n){}})})},captureKeycode:function(){document.addEventListener("keydown",function(i){if(i.altKey&&i.shiftKey&&i.keyCode==69){c.call([{methodname:"local_experience_keycode",args:{action:"editmode"},done:function(j){location.reload()},fail:e.exception}])}})},detectModification:function(){var i=false;["#activity-settings-modulesettings","body #course-settings-courseadmin","body#page-question-type-multichoice","form#add_block","form#chooserform",'form[action="modedit.php"]',".bcs-new-course.backup-section",".bcs-existing-course.backup-section"].forEach(function(j){if(g(j).length>0){i=true}});if(i){g(".nav-local-experience-switch .slider").addClass("rulesapplied");g(".nav-local-experience-btn").addClass("rulesapplied");g(".local_experience_wrapper>div").addClass("rulesapplied")}},enablePanelTrigger:function(l){var j=this;if(j.debug){console.log("local_experience/main:enablePanelTrigger(level)",l)}var k=g('#nav-drawer a[data-key="experiencelevel"]').addClass("nav-local-experience-btn").attr("onclick","var c = this; require(['local_experience/main'], function(m) { m.switchExperience(!$(c).hasClass('experience-advanced')); }); return false;");var i=k.find(".media-left");if(l==1){k.addClass("experience-advanced");i.html('<i class="fa fa-icon fa-toggle-on" style="font-size: 18px;"></i>')}else{i.html('<i class="fa fa-icon fa-toggle-off" style="font-size: 18px;"></i>')}},injectQuestionTemplate:function(i,k){if(this.debug){console.log("local_experience/main::injectQuestionTemplate(qtype, tid)",i,k)}var l=this;if(i=="stack"){var j=[{key:"injectquestion:stack:_ids",component:"local_experience"},{key:"injectquestion:stack:_fields",component:"local_experience"},];if(l.debug){console.log("metastrs",j)}f.get_strings(j).done(function(m){var o=g.map(m[0].split(","),Number);var p=m[1].split(",");if(l.debug){console.log("valid ids are ",o)}if(o.indexOf(k)==-1){alert("Invalid template id");return}var n=[];p.forEach(function(q){n.push({key:"injectquestion:stack:"+k+":"+q,component:"local_experience"})});if(l.debug){console.log("getstrs",n)}f.get_strings(n).done(function(q){n.forEach(function(r,s){var t=r.key;var u=p[s];var w=q[s];var x='form[action="question.php"] #id_'+u;var v=g(x);if(v.is("select")){g(x+" option[selected]").removeAttr("selected");if(l.debug){console.log("set "+x+' option[value="'+w+'"] to selected')}g(x+' option[value="'+w+'"]').attr("selected","selected").prop("selected",true)}else{if(v.is("textarea")||v.is("div")){if(l.debug){console.log("set "+x+" to ",w)}g(v).html(w.trim())}else{if(v.is("[type=checkbox]")){if(l.debug){console.log("set "+x+" to ",w)}g(v).prop("checked",(w==1))}else{if(l.debug){console.log("set "+x+" to ",w)}v.val(w)}}}})}).fail(e.exception)}).fail(e.exception)}},injectText:function(){if(this.debug){console.log("local_experience/main:injectText()")}var i=["page-question-type-ddwtos","page-question-type-multianswer","page-question-type-stack","page-question-type-wordselect","page-mod-bigbluebuttonbn-mod"];var j=g("body").attr("id");if(i.indexOf(j)>-1){c.call([{methodname:"local_experience_injecttext",args:{pageid:j},done:function(k){if(typeof k.text!=="undefined"&&k.text!=""){if(typeof k.appendto!=="undefined"&&k.appendto!=""){g(k.prependto).append(g("<p>").addClass("alert alert-info").html(k.text))}if(typeof k.prependto!=="undefined"&&k.prependto!=""){g(k.prependto).prepend(g("<p>").addClass("alert alert-info").html(k.text))}}},fail:e.exception}])}},setCompletionDefaults:function(i){if(this.debug){console.log("local_experience/main:setCompletionDefaults(daysplus)",i)}g("#region-main #id_completion").val(1).change();g("#region-main #id_completionexpected_enabled").prop("checked",true);var j=new Date();j.setDate(j.getDate()+parseInt(i));g("#region-main #id_completionexpected_day").val(j.getDate()).change();g("#region-main #id_completionexpected_month").val(j.getMonth()+1).change();g("#region-main #id_completionexpected_year").val(j.getFullYear()).change();g("#region-main #id_completionexpected_hour").val(j.getHours()).change();g("#region-main #id_completionexpected_minute").val(j.getMinutes()).change()},switchExperience:function(k){if(this.debug){console.log("local_experience/main:switchExperience(level)",k)}k=(k)?1:0;var i=g(".nav-local-experience-btn");if(k==1){i.addClass("experience-advanced");i.find(".media-left i").removeClass("fa-toggle-off").addClass("fa-toggle-on")}else{i.removeClass("experience-advanced");i.find(".media-left i").removeClass("fa-toggle-on").addClass("fa-toggle-off")}g("body").removeClass("local-experience-level-0").removeClass("local-experience-level-1").addClass("local-experience-level-"+k);var j=this;c.call([{methodname:"local_experience_switch",args:{level:k},done:function(l){if(l==1){}},fail:e.exception}])},}});